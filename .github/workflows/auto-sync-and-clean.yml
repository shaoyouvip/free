name: Auto Sync Fork & Clean Subscription

on:
  schedule:
    - cron: '0 16 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´ 0 ç‚¹æ‰§è¡Œï¼ˆUTC 16 ç‚¹ï¼‰
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main                # å½“ main æœ‰æ›´æ–°æ—¶ä¹Ÿæ‰§è¡Œ

jobs:
  sync_and_clean:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # === Step 1: æ‹‰å–ä»“åº“ ===
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # === Step 2: é…ç½® Git ç”¨æˆ·ä¿¡æ¯ ===
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # === Step 3: åŒæ­¥ä¸Šæ¸¸ä»“åº“ ===
      - name: Add upstream and fetch
        run: |
          echo "ğŸ”„ æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶åŒæ­¥æœ€æ–°æäº¤..."
          git remote add upstream https://github.com/shaoyouvip/free.git || true
          git fetch upstream
          git checkout main
          git rebase upstream/main || (git rebase --abort && git reset --hard upstream/main)
          echo "âœ… ä¸Šæ¸¸åŒæ­¥å®Œæˆã€‚"

      # === Step 4: ä¸‹è½½å¹¶æ¸…ç†è®¢é˜…æ–‡ä»¶ï¼ˆè¦†ç›–åŸæ–‡ä»¶ï¼‰ ===
      - name: Download and clean subscription
        run: |
          echo "ğŸŒ æ­£åœ¨ä¸‹è½½è®¢é˜…æ–‡ä»¶..."
          # ä½¿ç”¨ raw.githubusercontent çš„å¸¸è§å½¢å¼ï¼Œé¿å… refs/heads æ··æ·†
          curl -s -L "https://raw.githubusercontent.com/tonygyf/free/main/base64.txt" -o base64.txt

          if [ ! -s base64.txt ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©ºï¼Œé€€å‡ºã€‚"
            exit 1
          fi

          echo "ğŸ§¹ åˆ é™¤è¡Œå°¾æˆ–ç‹¬ç«‹çš„æ—¶é—´æˆ³æ³¨é‡Šï¼ˆä¾‹å¦‚ ' # 2025-10-23 19:13:16' æˆ–å•ç‹¬ä¸€è¡Œ '# 2025-10-23'ï¼‰..."
          # å°†åŒ¹é…å¹¶åˆ é™¤è¡Œå°¾æˆ–æ•´è¡Œçš„æ—¶é—´æˆ³æ³¨é‡Šï¼š
          # - åŒ¹é…å¯é€‰ç©ºç™½ï¼Œ#ï¼Œå¯é€‰ç©ºç™½ï¼Œæ—¥æœŸï¼ˆyyyy-mm-ddï¼‰å’Œå¯é€‰æ—¶é—´éƒ¨åˆ†
          # - ä»…åˆ é™¤è¯¥æ³¨é‡Šéƒ¨åˆ†ï¼Œä¸ç ´åå…¶å®ƒå†…å®¹
          sed -E -i 's/[[:space:]]*# *[0-9]{4}-[0-9]{2}-[0-9]{2}([ T][0-9]{2}:[0-9]{2}:[0-9]{2})?$//g' base64.txt

          # ï¼ˆå¯é€‰ï¼‰å»é™¤è¡Œå°¾å¤šä½™ç©ºç™½
          sed -i 's/[[:space:]]\+$//' base64.txt

          echo "âœ… æ¸…ç†å®Œæˆï¼Œç”Ÿæˆå¹¶è¦†ç›– base64.txt"
          ls -lh base64.txt

      # === Step 5: æäº¤å¹¶æ¨é€ä¿®æ”¹ï¼ˆè¦†ç›–åŸæ–‡ä»¶ï¼‰ ===
      - name: Commit and push changes
        run: |
          git add base64.txt
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            echo "ğŸ“¦ æ£€æµ‹åˆ°å˜åŒ–ï¼Œæäº¤ä¸­..."
            git commit -m "Auto-sync upstream and clean subscription (normalize base64.txt) [skip ci]"
            git push origin main --force
            echo "âœ… æäº¤å¹¶æ¨é€å®Œæˆã€‚"
          fi

      # === Step 6: å®Œæˆæç¤º ===
      - name: Done
        run: echo "ğŸ‰ æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚"
