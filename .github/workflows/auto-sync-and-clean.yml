name: Auto Sync Fork & Clean Subscription

on:
  schedule:
    - cron: '0 16 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´ 0 ç‚¹æ‰§è¡Œï¼ˆUTC 16 ç‚¹ï¼‰
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main                # å½“ main æœ‰æ›´æ–°æ—¶ä¹Ÿè¿è¡Œ

jobs:
  sync_and_clean:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # === Step 1: æ‹‰å–ä»“åº“ ===
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # === Step 2: é…ç½® Git ç”¨æˆ·ä¿¡æ¯ ===
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # === Step 3: åŒæ­¥ä¸Šæ¸¸ä»“åº“ ===
      - name: Add upstream and fetch
        run: |
          echo "ğŸ”„ æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶åŒæ­¥æœ€æ–°æäº¤..."
          git remote add upstream https://github.com/shaoyouvip/free.git || true
          git fetch upstream
          git checkout main
          git rebase upstream/main || (git rebase --abort && git reset --hard upstream/main)
          echo "âœ… ä¸Šæ¸¸åŒæ­¥å®Œæˆã€‚"

      # === Step 4: ä¸‹è½½å¹¶æ¸…ç†æœ¬åœ°è®¢é˜…æ–‡ä»¶ ===
      - name: Download and clean subscription
        run: |
          echo "ğŸŒ æ­£åœ¨ä¸‹è½½è®¢é˜…æ–‡ä»¶..."
          curl -s -L "https://raw.githubusercontent.com/tonygyf/free/refs/heads/main/base64.txt" -o base64.txt

          if [ ! -s base64.txt ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©ºï¼Œé€€å‡ºã€‚"
            exit 1
          fi

          echo "ğŸ§¹ åˆ é™¤å°¾éƒ¨æ—¶é—´æˆ³..."
          # åŒ¹é…å¹¶åˆ é™¤ä»¥ # YYYY-MM-DD å¼€å¤´çš„æ—¶é—´è¡Œ
          sed '/^# [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/d' base64.txt > base64_clean.txt

          echo "âœ… æ¸…ç†å®Œæˆï¼Œç”Ÿæˆ base64_clean.txt"
          ls -lh base64_clean.txt

      # === Step 5: æäº¤å¹¶æ¨é€ä¿®æ”¹ ===
      - name: Commit and push changes
        run: |
          git add base64_clean.txt
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          else
            echo "ğŸ“¦ æ£€æµ‹åˆ°å˜åŒ–ï¼Œæäº¤ä¸­..."
            git commit -m "Auto-sync upstream and clean subscription file (generated base64_clean.txt) [skip ci]"
            git push origin main --force
            echo "âœ… æäº¤å¹¶æ¨é€å®Œæˆã€‚"
          fi

      # === Step 6: å®Œæˆæç¤º ===
      - name: Done
        run: echo "ğŸ‰ æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚"
